name: Weekly Link Audit

on:
  schedule:
    # Run every Monday at 9am UTC (2am MST)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Link Checker
        id: check
        continue-on-error: true
        run: |
          node scripts/check-links.js --json > link-report.json 2>&1 || true
          node scripts/check-links.js > link-report.md 2>&1 || true

          # Extract summary for the issue
          BROKEN=$(jq '.summary.broken' link-report.json)
          SOFT404=$(jq '.summary.soft404' link-report.json)
          REDIRECTS=$(jq '.summary.suspiciousRedirects' link-report.json)
          TIMEOUTS=$(jq '.summary.timeouts' link-report.json)
          ERRORS=$(jq '.summary.errors' link-report.json)
          TOTAL_ISSUES=$((BROKEN + SOFT404 + REDIRECTS + TIMEOUTS + ERRORS))

          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          echo "soft404=$SOFT404" >> $GITHUB_OUTPUT
          echo "redirects=$REDIRECTS" >> $GITHUB_OUTPUT
          echo "timeouts=$TIMEOUTS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

      - name: Create or Update Issue
        if: steps.check.outputs.total_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('link-report.md', 'utf8');
            const jsonReport = JSON.parse(fs.readFileSync('link-report.json', 'utf8'));

            const issueTitle = `üîó Link Health Report: ${jsonReport.summary.broken + jsonReport.summary.soft404} broken links found`;

            // Look for existing open issue with our label
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'link-audit',
              state: 'open'
            });

            const issueBody = `## Automated Link Health Report

            This report was generated automatically on ${new Date().toISOString().split('T')[0]}.

            ### Quick Summary
            | Status | Count |
            |--------|-------|
            | ‚ùå Broken (HTTP errors) | ${jsonReport.summary.broken} |
            | üëª Soft 404s | ${jsonReport.summary.soft404} |
            | üîÄ Suspicious redirects | ${jsonReport.summary.suspiciousRedirects} |
            | ‚è±Ô∏è Timeouts | ${jsonReport.summary.timeouts} |
            | ‚ö†Ô∏è Errors | ${jsonReport.summary.errors} |

            <details>
            <summary>üìã Full Report (click to expand)</summary>

            ${report}

            </details>

            ---
            *This issue is automatically updated each week. Close it once all links are fixed.*
            `;

            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                title: issueTitle,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['link-audit', 'maintenance']
              });
              console.log('Created new issue');
            }

      - name: Close Issue if All Links Healthy
        if: steps.check.outputs.total_issues == 0
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'link-audit',
              state: 'open'
            });

            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ All links are now healthy! Closing this issue.'
              });
            }

      - name: Upload Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: link-reports
          path: |
            link-report.json
            link-report.md
          retention-days: 30
